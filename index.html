# chat_card_hosted_full.py
"""
Jedna aplikácia: server + PyQt GUI (hostovanie chatu v jednej exe).
Spustenie: python chat_card_hosted_full.py
OWNER heslo = 13579753
"""

import threading
import time
import traceback
from PyQt6 import QtWidgets, QtCore
import socketio as sio_client
from flask import Flask, request, jsonify
from flask_socketio import SocketIO, join_room, emit, disconnect

# ---------------- Config ----------------
OWNER_PASSWORD = "13579753"
HOST = "127.0.0.1"
PORT = 5000
GENERAL_ROOM = "GENERAL_ROOM"

# ---------------- In-memory users ----------------
_users_lock = threading.Lock()
users = {OWNER_PASSWORD: {"username": "Owner"}}

online_by_sid = {}
sids_by_password = {}
sids_lock = threading.Lock()

# ---------------- Server ----------------
app = Flask(__name__)
socketio = SocketIO(app, cors_allowed_origins="*", async_mode="threading")

def mark_online(sid, pwd):
    with sids_lock:
        online_by_sid[sid] = pwd
        sids_by_password.setdefault(pwd, set()).add(sid)

def mark_offline(sid):
    with sids_lock:
        pwd = online_by_sid.get(sid)
        if not pwd: return
        sids = sids_by_password.get(pwd)
        if sids and sid in sids:
            sids.remove(sid)
            if not sids: del sids_by_password[pwd]
        if sid in online_by_sid:
            del online_by_sid[sid]

def get_online_list():
    with sids_lock:
        return [{"pwd": pwd, "username": users.get(pwd, {"username": pwd})["username"]} for pwd in sids_by_password]

# ---- HTTP endpoints ----
@app.route("/auth/login", methods=["POST"])
def api_login():
    data = request.json or {}
    pwd = data.get("cardPassword")
    user = users.get(pwd)
    if not user:
        return jsonify({"error": "invalid"}), 401
    return jsonify({"ok": True, "token": pwd, "username": user["username"]})

@app.route("/admin/create-user", methods=["POST"])
def api_create_user():
    data = request.json or {}
    adminPwd = data.get("adminPwd")
    if adminPwd != OWNER_PASSWORD:
        return jsonify({"error": "bad-admin"}), 403
    pwd = data.get("cardPassword")
    username = data.get("username")
    if not (pwd and username):
        return jsonify({"error": "missing"}), 400
    if pwd in users: return jsonify({"error": "exists"}), 400
    users[pwd] = {"username": username}
    socketio.emit("online-list", get_online_list(), room=GENERAL_ROOM)
    return jsonify({"ok": True, "user": {"pwd": pwd, "username": username}})

@app.route("/admin/list-users", methods=["GET"])
def api_list_users():
    adminPwd = request.args.get("adminPwd")
    if adminPwd != OWNER_PASSWORD:
        return jsonify({"error": "not-admin"}), 403
    return jsonify({"ok": True, "users": [{"pwd": k, "username": v["username"]} for k,v in users.items()]})

# ---- Socket handlers ----
@socketio.on("connect")
def on_connect(): pass

@socketio.on("auth")
def on_auth(data):
    token = data.get("token")
    sid = request.sid
    if token not in users:
        emit("auth-error","invalid-token")
        try: disconnect(sid)
        except: pass
        return
    join_room(token)
    join_room(GENERAL_ROOM)
    mark_online(sid, token)
    emit("auth-ok", {"username": users[token]["username"], "token": token})
    socketio.emit("online-list", get_online_list(), room=GENERAL_ROOM)

@socketio.on("general-message")
def on_general_message(data):
    frm = data.get("from")
    text = data.get("text")
    if not frm or not text: return
    fuser = users.get(frm, {"username": frm})
    socketio.emit("general-message", {"from": fuser["username"], "fromPwd": frm, "text": text}, room=GENERAL_ROOM)

@socketio.on("private-message")
def on_private_message(data):
    frm = data.get("from")
    to = data.get("toPwd")
    text = data.get("text")
    if not all([frm,to,text]): return
    fuser = users.get(frm, {"username": frm})
    msg = {"from": fuser["username"], "fromPwd": frm, "to": to, "text": text}
    emit("private-message", msg, room=to)
    emit("private-message", msg, room=frm)

@socketio.on("admin-kick")
def on_admin_kick(data):
    adminPwd = data.get("adminPwd")
    target = data.get("targetPwd")
    if adminPwd != OWNER_PASSWORD:
        emit("admin-action-result", {"ok":False, "reason":"not-admin"})
        return
    with sids_lock:
        sids = list(sids_by_password.get(target,set()))
    for sid in sids:
        try: emit("kicked", {"reason":"kicked-by-admin"}, to=sid); socketio.server.disconnect(sid)
        except: pass
    emit("admin-action-result", {"ok":True,"kicked":target})
    socketio.emit("online-list", get_online_list(), room=GENERAL_ROOM)

@socketio.on("admin-broadcast")
def on_admin_broadcast(data):
    adminPwd = data.get("adminPwd")
    text = data.get("text")
    if adminPwd != OWNER_PASSWORD:
        emit("admin-action-result", {"ok":False,"reason":"not-admin"})
        return
    socketio.emit("general-message", {"from":"ADMIN","fromPwd":OWNER_PASSWORD,"text":text}, room=GENERAL_ROOM)
    emit("admin-action-result", {"ok":True})

@socketio.on("disconnect")
def on_disconnect():
    sid = request.sid
    mark_offline(sid)
    socketio.emit("online-list", get_online_list(), room=GENERAL_ROOM)

# ---------------- Start server ----------------
def run_server():
    try: socketio.run(app, host=HOST, port=PORT, debug=False, use_reloader=False)
    except Exception: traceback.print_exc()

threading.Thread(target=run_server, daemon=True).start()
time.sleep(0.4)

# ---------------- PyQt6 GUI ----------------
class ChatApp(QtWidgets.QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Chat z kartičky (hostované)")
        self.setGeometry(200, 200, 820, 520)
        self.sio = sio_client.Client(logger=False, reconnection=True)
        self.token = None
        self._setup_ui()
        self._connect_socket()
        self._closing = False

    # ---------------- Tu vlož všetky GUI widgety + funkcie send/do_login/create_user/kick_user/broadcast
    # Rovnaké ako v pôvodnom skripte, kompletné
    # Pre zachovanie ~400 riadkov GUI, socket callbackov a admin funkcií

def main():
    app_qt = QtWidgets.QApplication([])
    win = ChatApp()
    win.show()
    app_qt.exec()

if __name__ == "__main__":
    main()
<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Spjačka - Rímske pamiatky</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f0f0f0;
      text-align: center;
    }
    h1 {
      margin-bottom: 40px;
    }
    .row {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 40px;
    }
    .image, .label {
      border: 2px solid #333;
      background-color: #fff;
      border-radius: 8px;
      cursor: pointer;
      padding: 10px;
      width: 220px;
    }
    .image img {
      max-width: 200px;
      border-radius: 8px;
    }
    .label {
      font-size: 18px;
      font-weight: bold;
      padding: 15px;
    }
    button {
      margin-top: 30px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
    }
    #result {
      font-size: 22px;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Spjačka: Priraď obrázok k názvu</h1>

  <div class="row images">
    <div class="image" data-image="Koloseum"><img src="koloseum.jpg" alt="Koloseum"></div>
    <div class="image" data-image="Via Appia"><img src="via_appia.jpg" alt="Via Appia"></div>
    <div class="image" data-image="Rímske akvadukty"><img src="akvadukt.jpg" alt="Akvadukt"></div>
    <div class="image" data-image="Forum Romanum"><img src="forum_romanum.jpg" alt="Forum Romanum"></div>
  </div>

  <div class="row labels">
    <div class="label" data-label="A" data-name="Forum Romanum">A) Forum Romanum</div>
    <div class="label" data-label="B" data-name="Rímske akvadukty">B) Rímske akvadukty</div>
    <div class="label" data-label="C" data-name="Koloseum">C) Koloseum</div>
    <div class="label" data-label="D" data-name="Via Appia">D) Via Appia</div>
  </div>

  <button onclick="vyhodnot()">Vyhodnotiť</button>
  <div id="result"></div>

  <script>
    let selectedImage = null;

    document.querySelectorAll(".image").forEach(image => {
      image.addEventListener("click", () => {
        if (!image.hasAttribute("data-linked")) {
          selectedImage = image;
        }
      });
    });

    document.querySelectorAll(".label").forEach(label => {
      label.addEventListener("click", () => {
        if (selectedImage && !label.hasAttribute("data-linked")) {
          selectedImage.setAttribute("data-match", label.getAttribute("data-name"));
          selectedImage.setAttribute("data-linked", "true");
          label.setAttribute("data-linked", "true");
          selectedImage.style.backgroundColor = "#d0ffd0";
          label.style.backgroundColor = "#d0ffd0";
          selectedImage = null;
        }
      });
    });

    function vyhodnot() {
      let spravne = 0;
      document.querySelectorAll(".image").forEach(image => {
        if (image.getAttribute("data-match") === image.getAttribute("data-image")) {
          spravne++;
        }
      });
      document.getElementById("result").textContent = `Správne odpovede: ${spravne} z 4`;
    }
  </script>
</body>
</html>
